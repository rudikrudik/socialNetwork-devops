---

- block:
  - name: Wget init database sql script
    ansible.builtin.get_url:
      url: "https://raw.githubusercontent.com/rudikrudik/socialNetwork/master/backend/create_db.sql"
      dest: "{{ sql_pach }}/create_db.sql"

  - name: "Service -> [{{ name }}]"
    community.docker.docker_container:
      name: "{{ name }}"
      image: "{{ name }}:{{ version }}"
      recreate: true
      state: startedbbb
      restart: yes
      ports:
        - "5432:5432"
      hostname: postresqlServer
      env:
        POSTGRES_DB: "{{ db_env.db_data }}"
        POSTGRES_USER: "{{ db_env.user }}"
        POSTGRES_PASSWORD: "{{ db_env.password }}"
        PGDATA: "/var/lib/postgresql/data"
      volumes:
        - "{{ sql_pach }}:/docker-entrypoint-initdb.d"
        - "{{ db_path }}:/var/lib/postgresql/data"
      healthcheck:
        test: ["CMD-SHELL", "pg_isready -U {{ db_env.user }} -d {{ db_env.db_data }}"]
        interval: 10s
        timeout: 5s
        retries: 5
        start_period: 10s
      restart_policy: unless-stopped
  tags: "{{ name }}"